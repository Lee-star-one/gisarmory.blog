# leaflet中如何优雅的解决百度、高德地图的偏移问题

话不多说，先上效果图

（最终事例效果GIF图）



以前在做项目时，经常会听到客户说，你们这个地图是哪来的，太丑了，能不能换成百度地图……高德也行……

大家生活中，手机出行和导航软件基本都已经习惯了使用百度地图和高德地图，而在做项目时，用这两个地图做为底图，也基本已经成为了标配。但在开发中使用这两个地图，会遇到一个拦路虎，坐标偏移问题。

全球现在用的最多的坐标，是wgs84坐标，专业GPS设备和手机GPS定位得到的坐标，通常都是这个坐标。我们国家为了保密需要，要求在国内发布的互联网地图，必须要在这个基础上进行加密偏移。加密后的坐标叫做国测局坐标，俗称火星坐标。高德地图、腾讯地图、国内的谷歌地图用的就是这个坐标。百度地图的坐标，则是在火星坐标的基础上再次加密。形成了百度坐标。



leaflet有一个加载互联网地图的插件，可以轻松实现加载高德、百度、天地图、谷歌等在线地图瓦片。但并没有去解决它们的偏移问题。

这就意味着如果使用百度地图作为底图。就需要把所有数据转换成百度坐标，才能正确地显示在地图上。同理，高德地图需要把所有数据转换成火星坐标。虽然高德地图和百度地图都提供了wgs84坐标转成自己坐标的在线接口，但仅支持单向转入，不支持反向再转回来。

网上流传着一份wgs84坐标、国测局坐标、百度坐标，这三者之间相互转换的算法。自己一开始也是将信将疑，但经过多个项目的实际检验后，发现绝大多数情况下误差都很小，也就几米左右，个人感觉只要不是测绘类的项目，这个误差还是可以接受的。



接下来就是如何把这个纠偏算法集成到leaflet中。四个方案：

方案一，把纠偏算法封装成一个接口，类似上面提到的百度高德坐标转换接口，在向地图加载数据前，先调用这个接口完成坐标的转换再添加到地图上。

优点：简单易行，容易实现，灵活控制。和百度高德的接口相比，自己接口的优势在于坐标可以任意可以互转，比如在高德地图上拾取点位后，自己的接口还能把坐标再转回wgs84。

缺点：每次新写功能，都需要自己去调用接口进行数据转换。麻烦！



方案二，把leaflet包装一层， 凡是涉及到有和地图进行数据交互的功能，比如：添加点、线、面、标注、绘图、拾取坐标等方法，都封装起来，并在这些封装的方法中加入纠偏算法。以后再用上面那些功能时，就用自己封装的这一套，这样在使用地图时就会自动完成坐标的纠偏。

优点：相比方案一，不用每次都手动调用了。

缺点：需要把leaflet所有的对外涉及到经纬度的接口都封装一遍，后续如果添加一些插件，这些插件的经纬度接口也要封装，也是一个不小的工作量。麻烦！



方案三，修改leaflet源码，把纠偏算法集成到源码中。找到所有和地图交互的底层基础类，在这些地方添加坐标纠偏算法。

优点：相比方案二，代码量会小一些。后续添加插件也不需要再去增加纠偏了。

缺点：1、正所谓成也萧何败萧何，这种玩法需要对leaflet的源码有足够的了解，如果对leaflet源码理解的不够透彻，或修改后测试不够全面，很容易写出莫名其妙的bug。

2、后续leaflet版本升级比较麻烦，需要重新修改一遍源码。 



方案四，终极杀招，前面三个方案都是属于被百度、高德的数据转换接口给带乱了节奏，满脑子都是考虑如何对数据进行纠偏（百度高德的api不开源，所以它们只能对数据下手）。但，leaflet是开源的啊……这就意味着，我们可以去对百度高德的底图就行纠偏，把偏移的底图掰回来，而不再是让数据去将错就错。

所以，这次换个思路，不折腾数据了，来搞搞瓦片。百度高德的地图都是瓦片地图，他们会作为一个image图层加载到leaflet中，每一张瓦片在加载时都会去计算它的经纬度位置，我们可以在计算位置时加入纠偏算法，把瓦片的坐标位置纠偏回来。

优点：相比前三个方案，需要修改的代码量会少很多，修改的源码少了，潜在的bug也会少很多。

缺点：需要对leaflet的源码有一定的理解。



方案一二三是把我们数据的坐标偏移成国测局或百度坐标。方案四是把国测局、百度坐标的瓦片纠偏成wgs84坐标。
这四种方案，一二四方案都亲自实施过，方案三研究过，没有实施，原因是感觉自己会写出一车bug。个人认为方案四的效果最佳，也是目前一直在用的。



接下来详细介绍一下方案四。
先看这个加载互联网的插件，它是继承了xx类，

（图片）

xx类中请求瓦片的地址在这里，

（图片）

请求过来了以后，要计算这张瓦片放置在地图上的经纬度位置
我们要做的就是把这个位置通过纠偏算法，给偏移回来。这样就等于把底图纠偏了回来。



还存在一个问题，现在的方式需要修改leaflet的源码，这样每次leaflet升级时，都需要重新加入这部分。在仔细研究了leaflet源码的风格以后，决定参考源码的 include 方式。

比如，源码中 Polygon.toGeoJSON() 方法不是在 Polygon.js 文件中写的，而是用 include 方式写在了GeoJSON.js文件中。

![](http://blogimage.gisarmory.xyz/20200818073542.png)

可以尝试已插件的形式把需要修改的方法重写，具体如下。（代码）这样我们就可以把这套对百度高德地图纠偏的功能封装成一个插件，大家引用这个插件就能实现对地图的纠偏了

注意：lf会以map初始化以后，加载的第一个图层的坐标，作为整个map的坐标，所以地图初始化以后，要第一个添加高德或百度地图作为底图。
体验一下纠偏完成后的效果（网址链接）插件和事例的完整代码（github链接）

总结：lf有一个加载国内互联网地图的插件，但存在坐标偏移问题。常见的偏移坐标有国测局坐标和百度坐标。网上有一份wgs84坐标国测局坐标和百度坐标相互转换的纠偏算法，需要自己集成到lf中纠偏算法集成到lf中有两种思路，一种是把自己的数据偏移到互联网地图，另一种是把互联网地图的瓦片纠偏回自己的数据。采用第二种思路，把纠偏算法封装成插件，对互联网地图的瓦片纠偏，在插件中复写源码的方式最为优雅。
关注GIS兵器库的公众号，有更新时第一时间获取
如果你觉得对你有帮助，点个关注（赞），这就是对我们最大的鼓励。
如果对文章内容有疑问，请留言（请在xx留言），我们一起交流学习。	